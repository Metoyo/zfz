<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title class="title"></title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
  <link rel="stylesheet" href="/weixin/css/paper.css"/>
</head>
<body ontouchstart>
<!--试卷作答模板-->
<script id="tplPaper" type="text/html">
  <h1 class="center fz18">{{title}}({{page}}/{{totalPg}})</h1>
  <div>
    <h4 class="tiGan">{{tiMu['题目内容']['题干']}}</h4>
    {{each tiMu['题目内容']['选项'] as tznr j}}
    <div class="tiZhi ptb10">
      <input type="radio" name="{{'radio' + tiMu['题目ID']}}" value="{{tiMu['题目ID'] + '-' + j}}" id="{{'radio' + tiMu['题目ID'] + '_' + j}}" class="tiZhiOpt"/>
      <label for="{{'radio' + tiMu['题目ID'] + '_' + j}}"> ({{letterArr[j]}}) {{tznr}} </label>
    </div>
    {{/each}}
  </div>
</script>
<script id="tplScore" type="text/html">
  <h1 class="center fz18" style="margin-top: 100px">答题总数: {{allTm}}，答对题数: {{rightTm}}</h1>
</script>
<!--内容容器-->
<div class="container" id="container">
  <div id="content" class="content">
  </div>
  <div id="nav" class="nav">
    <a href="javascript:;" id="prvBtn" class="navBtn">
      <p class="weui_tabbar_label">上一题</p>
    </a>
    <a href="javascript:;" id="nextBtn" class="navBtn">
      <p class="weui_tabbar_label">下一题</p>
    </a>
    <a href="javascript:;" id="submitTest" class="navBtn submitTest">
      <p class="weui_tabbar_label">结束测试</p>
    </a>
  </div>
  <div class="nameInput">
    <div class="inner">
      <h1 class="center">请输入你的姓名</h1>
      <p class="center"><input type="text" name="yourName" class="nameWrap"/></p>
      <p class="center"><a href="javascript:;" class="btn" id="submitBtn">确定</a></p>
    </div>
  </div>
</div>
<!--用到的ji文件-->
<script src="/weixin/js/jquery-3.1.0.min.js"></script>
<script src="/weixin/js/markitup/MathJax.js?config=TeX-AMS-MML_SVG-full"></script>
<script src="/weixin/js/template.js"></script>
<script>
  $(function(){
    var yongHuCeYan = '/yonghu_ceyan'; //用户测试
    var yongHuDaTi = '/yonghu_dati'; //用户答题
//        var par = location.search; //获得测试ID
//        var parArr = par.split('?');
//        var testID = parseInt(parArr[1]);
    var testID = +$('.testId').val();
    var tiMuArr = []; //题目数组
    var zhuCeId = ''; //注册ID
    var daTiArr = []; //已答题目数组
    var paperLen = ''; //题目数量
    var currentPg = ''; //当前页码
    var paperTitle= ''; //试卷名称
    var wrapSlt = $('#content');
    var ziMu =  ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P',
      'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z']; //英文字母序号数组
    //返回的数据类型处理
    var dataMake = function(dt){
      if(typeof(dt) == 'string'){
        return JSON.parse(dt);
      }
      else{
        return dt;
      }
    };

    var tmRender = function(d, t, p, a){
      var dt = {
        title: t,
        page: p,
        tiMu: d,
        totalPg: a,
        letterArr: ziMu
      };
      var html = template('tplPaper', dt);
      wrapSlt.html(html);
      MathJax.Hub.Config({
        tex2jax: {inlineMath: [["#$", "$#"]], displayMath: [['#$$','$$#']]},
        messageStyle: "none",
        showMathMenu: false,
        processEscapes: true
      });
      MathJax.Hub.Queue(["Typeset", MathJax.Hub, "content"]);
      var tmId = d['题目ID'];
      var daTiLen = daTiArr.length;
      for(var i = 0; i < daTiLen; i++){
        if(daTiArr[i]['题目ID'] == tmId){
          var idx = parseInt(daTiArr[i]['答案']);
          $('.tiZhiOpt').eq(idx).prop('checked', true);
        }
      }
      if(p == a){
        $('.submitTestWrap').show();
      }
      else{
        $('.submitTestWrap').hide();
      }
    };
    var initFun = function(){
      $.ajax({
        method: 'PUT',
        url: yongHuCeYan,
        data: {
          '测验ID':testID
        },
        success: function (data) {
          data = dataMake(data);
          if(data.result && data.data && data.data['测验题目'][0]['题目'].length > 0){
            var tmpTitle = data.data['测验题目'][0]['大题名称'];
            var tmpTitleArr = tmpTitle.split('-');
            paperTitle = tmpTitleArr[1];
            tiMuArr = data.data['测验题目'][0]['题目'];
            zhuCeId = data.data['注册ID'];
            paperLen = tiMuArr.length;
            currentPg = 1;
            if(paperLen == 1){
              $('#prvBtn').hide();
              $('#nextBtn').hide();
              $('#submitTest').show().css({width: '100%'});
            }
            tmRender(tiMuArr[0], paperTitle, currentPg, paperLen);
          }
          else{
            alert(data.error || '没有题目！');
          }
          $('.testId').remove();
        },
        error: function (error) {
          alert(error);
        }
      });
    };
    initFun();

    //答题
    wrapSlt.on('click', '.tiZhiOpt', function(){
      var daStr = $(this).val();
      var daArr = daStr.split('-');
      var da = daArr[1];
      var tmId = parseInt(daArr[0]);
      var daTiLen = daTiArr.length;
      var daObj = {
        '题目ID': tmId,
        '答案': da
      };
      var noIn = true;
      for(var i = 0; i < daTiLen; i++){
        if(daTiArr[i]['题目ID'] == tmId){
          daTiArr[i]['答案'] = da;
          noIn = false;
        }
      }
      if(noIn){
        daTiArr.push(daObj);
      }
    });

    //上一页
    $('#prvBtn').on('click', function(){
      -- currentPg;
      if(currentPg >= 1){
        var dt = tiMuArr[currentPg - 1];
        if(currentPg < paperLen){
          $('#nextBtn').show();
          $('#submitTest').hide();
        }
        tmRender(dt, paperTitle, currentPg, paperLen);
      }
      else{
        currentPg = 1;
        alert('已经到第一题！');
      }
    });

    //下一页
    $('#nextBtn').on('click', function(){
      ++ currentPg;
      var dt = tiMuArr[currentPg - 1];
      if(currentPg <= paperLen){
        if(currentPg == paperLen){
          currentPg = paperLen;
          $(this).hide();
          $('#submitTest').show();
        }
        tmRender(dt, paperTitle, currentPg, paperLen);
      }
    });

    //结束测验
    $('#nav').on('click', '#submitTest', function(){
      var yiDaLen = daTiArr.length;
      var cut = paperLen - yiDaLen;
      var subFun = function(){
        $.ajax({
          method: 'POST',
          url: yongHuDaTi,
          data: {
            '注册ID': zhuCeId,
            '测验ID':testID,
            '答题': JSON.stringify(daTiArr)
          },
          success: function (data) {
            if(typeof(data) == 'string'){
              data = JSON.parse(data);
            }
            if(data.result){
              $('.nameInput').show();
            }
            else{
              alert(data.error);
            }
          },
          error: function (error) {
            alert(error);
          }
        });
      };
      if(cut > 0){
        if(confirm('有' + cut + '未作答！确定要提交吗？')){
          subFun();
        }
      }
      else{
        subFun();
      }
    });

    //输入姓名后的确认
    $('#submitBtn').on('click', function(){
      var name = $('.nameWrap').val() || '匿名';
      $.ajax({
        method: 'POST',
        url: yongHuCeYan,
        data: {
          '注册ID': zhuCeId,
          '测验ID':testID,
          '姓名':name
        },
        success: function (data) {
          if(typeof(data) == 'string'){
            data = JSON.parse(data);
          }
          if(data.result){ //关闭页面
            var dt = {
              allTm: data.data['答题总数'],
              rightTm: data.data['答对题数']
            };
            var html = template('tplScore', dt);
            wrapSlt.html(html);
            $('.nameInput').hide();
            $('#nav').hide();
          }
          else{
            alert(data.error);
          }
        },
        error: function (error) {
          alert(error);
        }
      });
    });
  });
</script>
</body>
</html>
