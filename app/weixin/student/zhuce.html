<!DOCTYPE html>
<html lang="en">
<head>
    <title>用户注册</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/jquery.mobile-1.4.5.css"/>
    <link rel="stylesheet" href="css/weui.css"/>
    <link rel="stylesheet" href="css/weui.min.css"/>
    <script src="js/jquery-1.8.0.js"></script>
    <script src="js/jquery.mobile-1.4.5.js"></script>
    <script src="js/jquery.cookie.js"></script>
    <script src="js/template.js"></script>
    <script id="test" type="text/html">
        <option selected="selected" >选择学校</option>
        {{each xueXiao}}
        <option value="{{$value['学校ID']}}">{{ $value['学校名称'] }}</option>
        {{/each}}
    </script>
    <script id="yongHu_Success" type="text/html">
        <h2 class="weui_msg_title">{{title}}</h2>
        <table align="center" style="margin: auto auto">
            <tr>
                <td><p class="weui_msg_desc">姓名：</p></td>
                <td><p class="weui_msg_desc" align="left">{{yongHuMsg['姓名']}}</p></td>
            </tr>
            <tr>
                <td><p class="weui_msg_desc">学号：</p></td>
                <td><p class="weui_msg_desc" align="left">{{yongHuMsg['学号']}}</p></td>
            </tr>
            <tr>
                <td><p class="weui_msg_desc">邮箱：</p></td>
                <td><p class="weui_msg_desc" align="left">{{yongHuMsg['邮箱']}}</p></td>
            </tr>
        </table>
    </script>
    <script id="yongHu_Error" type="text/html">
        <h2 class="weui_msg_title">{{title}}</h2>
        <p class="weui_msg_desc">{{msg}}</p>
    </script>
</head>
<body>
<div data-role="page" id="zhuce_one">
    <div role="main" class="ui-content">
        <form id="wx_zhuceForm">
            <div class="ui-field-contain" id="">
                <label for="select-choice-3" class="select" >
                    选择学校
                    <span style="color: red ">*</span>
                </label>
                <select name="xuexiao" id="xuexiaoId" required>

                </select>
            </div>
            <div class="ui-field-contain">
                <label>
                    学号
                    <span style="color: red ">*</span>
                </label>
                <input type="text" name="学号" placeholder="学号" required title="学号4~30位之间！"
                       pattern=".{4,30}" data-clear-btn="true" autofocus="autofocus">
            </div>
            <div class="ui-field-contain">
                <label>
                    姓名
                    <span style="color: red ">*</span>
                </label>
                <input type="text" name="姓名" placeholder="姓名" required title="请填写姓名!"
                       data-clear-btn="true">
            </div>
            <br/><br/><br/><br/><br/>

            <div class="ui-field-contail">
                <input type="submit" id="submit1" value="下一步">
            </div>
        </form>
    </div>
</div>
<div data-role="page" id="zhuce_two">
    <div role="main" class="ui-content">
        <form id="wx_pass_mail">
            <div class="ui-field-contain">
                <label>
                    邮箱
                    <span style="color: red ">*</span>
                </label>
                <input type="email" id="emailId" placeholder="邮箱" required title="为了您账户的安全请填写真实邮箱!"
                       data-clear-btn="true">
            </div>
            <div class="ui-field-contain">
                <label>
                    密码
                    <span id="span_pass1" style="color: red ">*</span>
                </label>
                <input type="password" name="password" id="password" placeholder="密码" required title="请输入密码!"
                       data-clear-btn="true">
            </div>

            <br/><br/><br/><br/><br/>

            <div class="ui-field-contail">
                <input type="submit" id="submit2" value="注　册">
            </div>
        </form>
    </div>
</div>
<div data-role="page" id="zhuce_success">
    <div role="main" class="ui-content">
        <div class="weui_dialog_alert">
            <div class="weui_msg">
                <div class="weui_icon_area"><i class="weui_icon_success weui_icon_msg"></i></div>
                <div class="weui_text_area" id="yongHuShow">
                </div>
            </div>
        </div>
    </div>
</div>
<div data-role="page" id="zhuce_error">
    <div role="main" class="ui-content">
        <div class="weui_dialog_alert">
            <div class="weui_msg">
                <div class="weui_icon_area"><i class="weui_icon_warn weui_icon_msg"></i></div>
                <div class="weui_text_area" id="errorMsg">

                </div>
                <!--<div class="weui_extra_area">-->
                <!--<a href="" >查看详细信息</a>-->
                <!--</div>-->
            </div>
        </div>
    </div>
</div>
</body>
</html>
<script type="text/javascript">
    $(document).ready(function () {
        var zhuCeSuccess = "#zhuce_success";
        var zhuCeError = "#zhuce_error";
        var successTitle = "注册成功";
        var successMsg = "该用户已经注册过";
        var errorTitle = "注册失败";
        var errorMsg = "用户信息不匹配,请使用Excel文件导入个人信息";
//        var localUrl = 'http://www.zhifz.com';
        var localUrl = 'http://127.0.0.1:3000';
        var loginUrl = "/login"; //登录
        var xueXiaoUrl = "/xuexiao";//学校
        var yongHuUrl = "/yonghu";
        /**
         * 用户注册登录
         */
        var userLogin = function (stu) {
            $.ajax({
                method: "GET",
                url: localUrl + loginUrl,
                data: {学号: stu['学号'], 学校ID: stu['学校ID'], 密码: '199403160323'},
//                data:{'微信ID':'ox7FGwuBkJym6sRyLRAFbldXD3aM'},
                async: false,
//                data: {'邮箱': stu['邮箱'], '密码': '199403160323'},
                success: function (usr) {
                    console.log(usr);
                    $.cookie("UID",usr.data['UID']);
                    $.cookie("学校ID",usr.data['学校ID']);
                    userLogin = usr.result;
                },
                error: function (error) {
                    alert(error);
                }
            });
            return userLogin;
        };

        /**
         * 提示注册成功页面
         */
        function zhuCe_Success(data, title) {
            var yongHu_Success = {
                title: title,
                yongHuMsg: data
            };
            var html = template('yongHu_Success', yongHu_Success);
            document.getElementById('yongHuShow').innerHTML = html;

        }

        /**
         * 提示用户注册错误页面
         */
        function zhuCe_Error(title, msg) {
            var yongHu_Error = {
                title: title,
                msg: msg
            };
            var html = template('yongHu_Error', yongHu_Error);
            document.getElementById('errorMsg').innerHTML = html;
        }

        /**
         * 修改保存openId
         */
        var saveOpenId = function(usr) {
            var openId = "ox7FGwuBkJym6sRyLRAFbldXD3aM";
            $.ajax({
                method:"POST",
                url:localUrl + yongHuUrl,
                data: {'UID':usr['UID'], '微信ID':openId},
                async: false,
                success: function (data) {
                    data = jQuery.parseJSON(data);
                    console.log(data);
                    saveOpenId = data.result;
                },
                error: function (error) {
                    alert(error);
                }
            });
            return saveOpenId;
        };
        /**
         * 获取学校列表
         */
        $.ajax({
            method: "GET",
            url: localUrl + xueXiaoUrl,
            dataType: "json",
            success: function (xueXiao) {
                console.log(xueXiao);
                var test = {
                    xueXiao: xueXiao.data
                };
                var html = template('test', test);
                document.getElementById('xuexiaoId').innerHTML = html;
            },
            error: function (error) {
                alert(error);
            }
        });
        /**
         * 提交认证信息
         */
        $("#submit1").click(function () {
            var formData = $('#wx_zhuceForm').serialize();
            $.ajax({
                method: "get",
                url: localUrl + yongHuUrl,
                cache: false,
                data: formData,
                async: false,
                success: function (yonghu) {
                    yonghu = jQuery.parseJSON(yonghu);
                    if (yonghu.result && yonghu.data != null) {
                        if (userLogin(yonghu.data[0])) {
                            if (($("#xuexiaoId").attr("value")) == (yonghu.data[0]['学校ID'])) {
                                if (yonghu.data[0]['微信ID'] != null) {
                                    self.location = (zhuCeSuccess);
                                    zhuCe_Success(yonghu.data[0], successMsg);
                                } else {
                                    if (saveOpenId(yonghu.data[0])) {
                                        self.location = (zhuCeSuccess);
                                        zhuCe_Success(yonghu.data[0], successMsg);
                                    }else{
                                        self.location = (zhuCeError);
                                        zhuCe_Error(errorTitle);
                                    }
                                }
                            } else {
                                self.location = (zhuCeError);
                                zhuCe_Error(errorTitle, errorMsg);
                            }
                        } else {
                            self.location = ("#zhuce_two");
                        }
                    } else {
                        self.location = (zhuCeError);
                        zhuCe_Error(errorTitle, errorMsg);
                    }
                },
                error: function (error) {
                    alert(error);
                }
            });
        });
        /**
         * 完善用户信息
         *
         * 该功能未用实际数据测试过
         */
        $("#submit2").click(function () {
            var formData = $("#wx_pass_mail").serialize();
            $.ajax({
                method:"POST",
                url: localUrl + yongHuUrl,
                data: formData,
                async: false,
                success: function (data) {
                    if (data.result) {
                        self.location = (zhuCeSuccess);
                        zhuCe_Success(data.data, successTitle);
                    } else {

                    }
                },
                error: function (error) {
                    alert(error);
                }
            });
            return false;
        });
    });

</script>
